####

#### Example Results Files
# exampleResults/Covid-P001_NFSamples.csv @@@ Contains library_id and s3FastqR1 and s3FastqR2 that are fed into NextFlow pipeline. This file is generated by fetchAndupload.sh
# exampleResults/NFResults.csv @@@ Contains information obtained from Nextflow viralrecon run: Coverage, depth, sequence and intermediat file location
# exampleResults/NextCladeSequences_output.csv @@@ Contains infromation obtained from NextClade Analysis including quality, mutations, and clade.


args = commandArgs(trailingOnly=TRUE)

if(is.na(args[4])){
  print("You need to specify NFSamplesFile NextCladeOutputFile MetadataFile all in csv format.")
  print("Metadata file needs to include library_id, at least")
}

NFSamplesFile=args[1]
NCOutputFile=args[2]
MetadataFile=args[3]
PGOutputFile=args[4]
projectID=args[5]
projectID="COVID-P002"
NFSamplesFile="/tmp/NFResults.csv"
NCOutputFile="/tmp/NextCladeSequences_output.csv"
PGOutputFile="/tmp/Pangolin_output.csv"
MetadataFile="~/Downloads/Config_Run05022021.xlsx"

#### Merge NextFlow and NextClade results with sample Data

NFSamplesDF<-read.delim(file=NFSamplesFile,sep=",",header=F)
colnames(NFSamplesDF)<-NFSamplesDF[1,]
colnames(NFSamplesDF)
NFSamplesDF<-NFSamplesDF[-1,]

NCOutputDF<-read.table(file=NCOutputFile,sep=";")
colnames(NCOutputDF)<-NCOutputDF[1,]
NCOutputDF<-NCOutputDF[-1,]
colnames(NCOutputDF)[1]<-"library_id"
colnames(NCOutputDF)

PGOutputDF<-read.table(file=PGOutputFile,sep=",")
colnames(PGOutputDF)<-c("library_id","pangolin_lineage","pangolin_probability","pangoLEARN_version","pangolin_status","pangolin_note")

NFNCDF<-merge(NFSamplesDF,NCOutputDF,all.x=TRUE,by="library_id")
colnames(NFNCDF)
NFNCPGDF<-merge(NFNCDF,PGOutputDF,all.x=T,by="library_id")

MetadataDF<-xlsx::read.xlsx(MetadataFile,encoding = "UTF-8",sheetIndex=2)
colnames(MetadataDF)
colnames(MetadataDF)<-MetadataDF[1,]
MetadataDF<-MetadataDF[-1,]
colnames(MetadataDF)
### Polish encoding of accents and other shit
Encoding(MetadataDF$OriginatingLab[2])
MetadataDF<-MetadataDF[! rowSums(is.na(MetadataDF))==ncol(MetadataDF),]
MetadataDF<-MetadataDF[,! colSums(is.na(MetadataDF))==nrow(MetadataDF)]
MetadataDF[,"collection_date"]<-as.character((openxlsx::convertToDate(MetadataDF[,"collection_date"]))) ### Date format forced in template screw import up
MetadataDF$collection_date
# MetadataDF$OriginatingLab<-iconv(MetadataDF$OriginatingLab,from="UTF-8",to="TRANSLIT")
# MetadataDF$OriginatingLabAddress<-iconv(MetadataDF$OriginatingLabAddress,from="UTF-8",to="UTF-8")
# MetadataDF$OriginatingLabAuthors<-iconv(MetadataDF$OriginatingLabAuthors,from="UTF-8",to="UTF-8")
# MetadataDF$AnalysisComments<-iconv(MetadataDF$AnalysisComments,from="UTF-8",to="UTF-8")
# MetadataDF$RunProjectID<-iconv(MetadataDF$RunProjectID,from="UTF-8",to="UTF-8")

MetadataNFNCDF<-merge(MetadataDF,NFNCPGDF,by.x="library_id",by.y="library_id",all=T)
Encoding(MetadataNFNCDF$OriginatingLab[2])
colnames(MetadataNFNCDF)[1]<-"library_id"
MetadataDF$OriginatingLab
MetadataNFNCDF$RunProjectID

#### Producte reports for internal use
#### This will be project-specific and contain comprehensive pipeline information for further processing/or not
MetadataNFNCDF$StudyID<-as.factor(MetadataNFNCDF$StudyID)
levels(MetadataNFNCDF$StudyID)
for(study in levels(MetadataNFNCDF$StudyID)){
  mySubDF<-subset.data.frame(MetadataNFNCDF,StudyID==study)
  #Use ; for FS because mutation list have ","
  write.table(mySubDF,file=paste("/Users/mnoguera/Downloads/",projectID,"_",study,".csv",sep=""),row.names = F,fileEncoding = "UTF-8" ,sep=";")
}

### Keep track of study specific fasta files. These may be handy for internal result reporting.
for(study in levels(MetadataNFNCDF$StudyID)){
  system(paste("rm",paste("/Users/mnoguera/Downloads/",projectID,"_",study,".fasta",sep="")))
  mySubDF<-subset.data.frame(MetadataNFNCDF,StudyID==study)
  # fileConn<-file(paste("/Users/mnoguera/Downloads/",projectID,"_",study,".fasta",sep=""),)
  for (i in 1:nrow(mySubDF)){
    print(i)
    # writeLines(paste(">",mySubDF[i,"library_id"],"\n",mySubDF[i,"FastqSequence"],"\n"),fileConn)
    write(paste(">",mySubDF[i,"library_id"],"\n",mySubDF[i,"FastqSequence"]),file=paste("/Users/mnoguera/Downloads/",projectID,"_",study,".fasta",sep=""),append=T)
  }
  # close(fileConn)
}

write.table(MetadataNFNCDF,file=paste("/Users/mnoguera/Downloads/",projectID,".csv",sep=""),row.names = F,fileEncoding = "UTF-8" ,sep=";")
#### Produce files for GISAID batch upload


